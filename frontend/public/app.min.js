class StorageManager{constructor(){console.log("StorageManager constructor called"),this.API_BASE=window.location.origin+"/api",this.token=localStorage.getItem("token"),this.user=JSON.parse(localStorage.getItem("user")||"{}"),this.packages=[],this.borrowHistory=[],console.log("API_BASE:",this.API_BASE),console.log("Token exists:",!!this.token),console.log("User:",this.user),this.init()}init(){console.log("StorageManager init called"),console.log("Token and user.id check:",this.token,this.user.id),this.token&&this.user.id?(console.log("Showing main app"),this.showMainApp().then(()=>{const e=localStorage.getItem("pendingBorrowPackageId"),t=localStorage.getItem("pendingVerifyBorrowId");localStorage.removeItem("pendingBorrowPackageId"),localStorage.removeItem("pendingVerifyBorrowId"),setTimeout(()=>{e?(console.log("Opening pending borrow modal for package:",e),this.showBorrowModal(e)):t&&(console.log("Opening pending verify return modal for borrow:",t),this.showVerifyReturnModal(t))},500)})):(console.log("Showing login page"),this.showLoginPage()),this.setupEventListeners(),this.generateDefectCountInputs(),console.log("StorageManager init completed")}setupEventListeners(){console.log("Setting up event listeners...");const e=document.getElementById("loginForm"),t=document.getElementById("addItemForm");console.log("Login form found:",!!e),console.log("Add item form found:",!!t),e&&(e.addEventListener("submit",e=>this.handleLogin(e)),console.log("Login form listener attached")),t&&(t.addEventListener("submit",e=>this.handleAddItem(e)),console.log("Add item form listener attached")),document.addEventListener("click",e=>{console.log("Click event detected:",e.target);const t=e.target.matches("button")?e.target:e.target.closest("button");if(t&&!t.closest("form")&&(console.log("Button click detected, preventing default"),e.preventDefault()),"logoutBtn"===e.target.id||e.target.closest("#logoutBtn"))console.log("Logout button clicked"),e.preventDefault(),this.logout();else if("toggleFiltersBtn"===e.target.id||e.target.closest("#toggleFiltersBtn"))console.log("Toggle filters button clicked"),e.preventDefault(),this.toggleFilters();else if("refreshPackagesBtn"===e.target.id||e.target.closest("#refreshPackagesBtn"))console.log("Refresh packages button clicked"),e.preventDefault(),this.refreshPackages();else if("submitBorrowBtn"===e.target.id||e.target.closest("#submitBorrowBtn"))console.log("Submit borrow button clicked"),e.preventDefault(),this.submitBorrow();else if("submitVerifyReturnBtn"===e.target.id||e.target.closest("#submitVerifyReturnBtn"))console.log("Submit verify return button clicked"),e.preventDefault(),this.submitVerifyReturn();else if("submitEditBtn"===e.target.id||e.target.closest("#submitEditBtn"))console.log("Submit edit button clicked"),e.preventDefault(),this.submitEditPackage();else if(e.target.closest(".edit-btn")){console.log("Edit button clicked"),e.preventDefault();const t=e.target.closest(".edit-btn").getAttribute("data-package-id");console.log("Edit package ID:",t),this.editPackage(t)}else if(e.target.closest(".delete-btn")){console.log("Delete button clicked"),e.preventDefault();const t=e.target.closest(".delete-btn").getAttribute("data-package-id");console.log("Delete package ID:",t),this.deletePackage(t)}else if(e.target.closest(".borrow-btn")){console.log("Borrow button clicked"),e.preventDefault();const t=e.target.closest(".borrow-btn").getAttribute("data-package-id");console.log("Borrow package ID:",t),localStorage.setItem("pendingBorrowPackageId",t),window.location.reload()}else if(e.target.closest(".verify-return-btn")){console.log("Verify return button clicked"),e.preventDefault();const t=e.target.closest(".verify-return-btn").getAttribute("data-borrow-id");console.log("Verify return borrow ID:",t),localStorage.setItem("pendingVerifyBorrowId",t),window.location.reload()}else if(e.target.closest(".return-item-btn")){console.log("Return item button clicked"),e.preventDefault();const t=e.target.closest(".return-item-btn").getAttribute("data-borrow-id");console.log("Return item borrow ID:",t),this.returnItem(t)}else if(e.target.closest(".view-btn")){console.log("View button clicked"),e.preventDefault();const t=e.target.closest(".view-btn").getAttribute("data-package-id");console.log("View package ID:",t),this.viewPackageDetails(t)}else if(e.target.closest(".package-code-link")){console.log("Package code link clicked"),e.preventDefault();const t=e.target.closest(".package-code-link").getAttribute("data-package-id");console.log("Package code link package ID:",t),this.viewPackageDetails(t)}}),document.addEventListener("input",e=>{e.target.classList.contains("edit-defect-input")&&this.calculateEditTotalSamples()}),document.addEventListener("input",e=>{e.target.matches(".defect-count-input")&&this.calculateTotalSamples()}),document.addEventListener("change",e=>{e.target.matches("#filterPackageCode, #filterCategory, #filterShift, #filterAvailable")&&this.applyFilters()}),document.addEventListener("keyup",e=>{e.target.matches("#filterPackageCode")&&this.applyFilters()});const o=document.getElementById("mainTabs");o&&o.addEventListener("shown.bs.tab",e=>{"dashboard-tab"===e.target.id?this.loadPackages():"returns-tab"===e.target.id&&this.loadBorrowHistory()})}async apiCall(e,t="GET",o=null){console.log(`API Call: ${t} ${e}`,o);const r={method:t,headers:{"Content-Type":"application/json"}};this.token&&(r.headers.Authorization=`Bearer ${this.token}`),o&&(r.body=JSON.stringify(o));try{const t=await fetch(`${this.API_BASE}${e}`,r);if(console.log(`API Response: ${t.status} ${e}`),401===t.status)return console.log("Unauthorized - logging out"),this.logout(),null;const o=await t.json();if(console.log("API Result:",o),!t.ok)throw new Error(o.message||"API call failed");return o}catch(e){return console.error("API Error:",e),this.showAlert(e.message,"danger"),null}}async handleLogin(e){console.log("Login form submitted"),e.preventDefault();const t=document.getElementById("email").value,o=document.getElementById("password").value;if(t&&o){console.log("Login attempt with email:",t);try{const e=await this.apiCall("/auth/login","POST",{email:t,password:o});console.log("Login API response:",e),e&&e.token&&e.user?(console.log("Login successful"),this.token=e.token,this.user=e.user,localStorage.setItem("token",this.token),localStorage.setItem("user",JSON.stringify(this.user)),this.showAlert("Login successful!","success"),this.showMainApp()):(console.log("Login failed - invalid response:",e),this.showAlert("Login failed - please check your credentials","danger"))}catch(e){console.error("Login error:",e),this.showAlert("Login failed - "+(e.message||"Unknown error"),"danger")}}else this.showAlert("Please enter both email and password","warning")}logout(){localStorage.removeItem("token"),localStorage.removeItem("user"),this.token=null,this.user={},this.packages=[],this.borrowHistory=[],this.allPackages=[],this.showLoginPage()}showLoginPage(){try{const e=document.getElementById("loginPage"),t=document.getElementById("mainApp");e&&(e.style.display="block"),t&&(t.style.display="none")}catch(e){console.error("Error showing login page:",e)}}async showMainApp(){try{const e=document.getElementById("loginPage"),t=document.getElementById("mainApp"),o=document.getElementById("username"),r=document.getElementById("userRole");return e&&(e.style.display="none"),t&&(t.style.display="block"),o&&(o.textContent=this.user.username),r&&(r.textContent=this.user.role),await this.loadPackages(),await Promise.all([this.loadFilterOptions(),this.loadVerifiers(),this.loadBorrowHistory()]),!0}catch(e){return console.error("Error showing main app:",e),this.showAlert("Error loading application interface","error"),!1}}async loadPackages(){const e=await this.apiCall("/packages");e&&(this.packages=e,this.allPackages=[...e],this.renderPackagesTable())}async loadFilterOptions(){const e=await this.apiCall("/packages/options");e&&(this.populateSelect("filterCategory",e.categories),this.populateSelect("filterShift",e.shifts),this.populateSelect("category",e.categories))}async loadVerifiers(){const e=await this.apiCall("/verifiers");e&&this.populateSelect("verifierSelect",e,"Username","ID")}async loadBorrowHistory(){const e=await this.apiCall("/borrow-history");e&&(this.borrowHistory=e,this.renderBorrowHistoryTable())}populateSelect(e,t,o=null,r=null){const a=document.getElementById(e);a.querySelectorAll('option:not([value=""])').forEach(e=>e.remove()),t.forEach(e=>{const t=document.createElement("option");o&&r?(t.value=e[r],t.textContent=e[o]):(t.value=e,t.textContent=e),a.appendChild(t)})}renderPackagesTable(){const e=document.querySelector("#packagesTable tbody");e.innerHTML="",this.packages.forEach(t=>{const o=document.createElement("tr"),r="YES"===t["MATERIAL AT ENG ROOM"]?'<span class="badge bg-success">Available</span>':'<span class="badge bg-danger">Not Available</span>',a="Admin"===this.user.role,n=["Admin","Engineer"].includes(this.user.role)&&"YES"===t["MATERIAL AT ENG ROOM"];let s="";a&&(s+=`<button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-package-id="${t.ID}" title="Edit">\n                    <i class="fas fa-edit"></i>\n                </button>`,s+=`<button class="btn btn-sm btn-outline-danger me-1 delete-btn" data-package-id="${t.ID}" title="Delete">\n                    <i class="fas fa-trash"></i>\n                </button>`),n&&(s+=`<button class="btn btn-sm btn-outline-success borrow-btn" data-package-id="${t.ID}" title="Borrow">\n                    <i class="fas fa-hand-holding"></i>\n                </button>`);let i=`<button class="btn btn-sm btn-outline-info me-1 view-btn" data-package-id="${t.ID}" title="View Details">\n                <i class="fas fa-eye"></i>\n            </button>`;i+=s,o.innerHTML=`\n                <td>${t.ID}</td>\n                <td><span class="package-code-link" data-package-id="${t.ID}" style="cursor: pointer; color: #0066cc; text-decoration: underline;">${t.Packagecode||""}</span></td>\n                <td>${t.Packagedescription||""}</td>\n                <td>${t["Temporary Cabinet"]||""}</td>\n                <td>${t.Category||""}</td>\n                <td>${t["SampleCreatedByShift(A/B/C)"]||""}</td>\n                <td>${r}</td>\n                <td>${t.TotalSample||0}</td>\n                <td>${i||"No actions available"}</td>\n            `,e.appendChild(o)})}renderBorrowHistoryTable(){const e=document.querySelector("#borrowHistoryTable tbody");e.innerHTML="",this.borrowHistory.forEach(t=>{const o=document.createElement("tr"),r=new Date(t.due_at),a=r-new Date,n=Math.floor(a/36e5);let s="";"In Progress"===t.return_status&&(s=a>0?`<span class="timer-normal">${n}h left</span>`:'<span class="timer-warning">OVERDUE</span>');let i="";const l=parseInt(t.Borrower_ID),c=parseInt(t.Verifier_ID),d=parseInt(this.user.id);"Technician"===this.user.role&&"Pending"===t.return_status&&c===d?i=`<button class="btn btn-sm btn-success verify-return-btn" data-borrow-id="${t.ID}">\n                    <i class="fas fa-check"></i> Verify\n                </button>`:"Admin"===this.user.role?l===d&&"In Progress"===t.return_status?i=`<button class="btn btn-sm btn-warning return-item-btn" data-borrow-id="${t.ID}">\n                        <i class="fas fa-undo"></i> Return\n                    </button>`:"Pending"===t.return_status&&c===d&&(i=`<button class="btn btn-sm btn-success verify-return-btn" data-borrow-id="${t.ID}">\n                        <i class="fas fa-check"></i> Verify\n                    </button>`):"Engineer"===this.user.role&&l===d&&"In Progress"===t.return_status&&(i=`<button class="btn btn-sm btn-warning return-item-btn" data-borrow-id="${t.ID}">\n                    <i class="fas fa-undo"></i> Return\n                </button>`),o.innerHTML=`\n                <td>${t.Packagecode}</td>\n                <td>${t.BorrowerName}</td>\n                <td>${t.VerifierName}</td>\n                <td>${new Date(t.borrowed_at).toLocaleString()}</td>\n                <td>${r.toLocaleString()}<br>${s}</td>\n                <td>\n                    <span class="badge status-badge ${{"In Progress":"bg-warning",Pending:"bg-info",Approved:"bg-info",Returned:"bg-success","Returned with Remarks":"bg-warning"}[t.return_status]}">${t.return_status}</span>\n                    ${t.justification?`<br><small class="text-muted"><strong>Reason:</strong> ${t.justification}</small>`:""}\n                </td>\n                <td>${t.expected_samples}</td>\n                <td>${t.returned_samples||"-"}</td>\n                <td>${i||"-"}</td>\n            `,e.appendChild(o)})}generateDefectCountInputs(){const e=document.getElementById("defectCountsContainer");["Dummyunit","WhiteFM(Substrate)","BlackFM(Substrate)","Chip(Substrate)","Scratches(Substrate)","Crack(Substrate)","FMonFoot(Substrate)","FMonShoulder(Substrate)","NFA(Substrate)","PFA(Substrate)","Footburr(Substrate)","Shoulderbur(Substrate)","Exposecopper(Substrate)","Resinbleed(Substrate)","void(Substrate)","Copla(Substrate)","WhiteFM(Mold/MetalLid)","BlackFM(Mold/MetalLid)","EdgeChip(Mold/MetalLid)","CornerChip(Mold/MetalLid)","Scratches(Mold/MetalLid)","Crack(Mold/MetalLid)","Illegiblemarking(Mold/MetalLid)","WhiteFM(Die)","BlackFM(Die)","Chip(Die)","Scratches(Die)","Crack(Die)","WhiteFM(BottomDefect)","BlackFM(BottomDefect)","Chip(BottomDefect)","Scratches(BottomDefect)","Crack(BottomDefect)","Damageball(BottomDefect)","Multiple Defect","Pitch","Sliver","Ball Discoloration","Burr","FM on Dambar","FM on Lead","Expose Copper on Dambar","Mold Flash","Metallic Particle","Patchback","Bent Lead","Expose Tie Bar","Fiber","Tool Mark","Good Unit","Lead Shining","Acid Test Burr"].forEach(t=>{const o=document.createElement("div");o.className="col-md-3 col-sm-6";const r=t.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase());o.innerHTML=`\n                <div class="mb-2">\n                    <label class="form-label small">${r}</label>\n                    <input type="number" class="form-control form-control-sm defect-count-input"\n                           id="${t}" name="${t}" min="0" value="0">\n                </div>\n            `,e.appendChild(o)})}calculateTotalSamples(){const e=document.querySelectorAll(".defect-count-input");let t=0;e.forEach(e=>{t+=parseInt(e.value)||0}),document.getElementById("totalSamples").value=t}async deletePackage(e){if("Admin"!==this.user.role)return void this.showAlert("Only administrators can delete packages","error");const t=(this.allPackages||this.packages).find(t=>t.ID==e||t.ID==parseInt(e));if(!t)return void this.showAlert("Package not found","error");const o=`Are you sure you want to delete package "${t.Packagecode}"?\n\nThis action cannot be undone.`;if(confirm(o))try{await this.apiCall(`/packages/${e}`,"DELETE")&&(this.showAlert("Package deleted successfully!","success"),this.loadPackages())}catch(e){console.error("Delete error:",e),this.showAlert("Failed to delete package","error")}}async handleAddItem(e){e.preventDefault();const t=new FormData(e.target),o=Object.fromEntries(t.entries());if(!o.temporaryCabinet||!o.temporaryCabinet.match(/^C\d+-S\d+$/))return void this.showAlert("Temporary Cabinet must follow format CX-SXX","danger");await this.apiCall("/packages","POST",o)&&(this.showAlert("Package added successfully!","success"),e.target.reset(),this.calculateTotalSamples(),this.loadPackages(),setTimeout(()=>{const e=document.getElementById("dashboard-tab");e&&e.click()},1500))}async showBorrowModal(e){try{const t=(this.allPackages||this.packages).find(t=>t.ID==e||t.ID==parseInt(e));if(!t)return void this.showAlert("Package not found","error");const o=document.getElementById("borrowModal");if(!o)return console.error("Borrow modal element not found"),void this.showAlert("Error opening borrow modal","error");const r=bootstrap.Modal.getInstance(o)||new bootstrap.Modal(o,{backdrop:"static",keyboard:!1});r.show(),setTimeout(async()=>{try{await this.loadVerifiers();const o=document.getElementById("borrowPackageId"),a=document.getElementById("verifierSelect"),n=document.getElementById("borrowPackageDetails");if(!o||!a||!n)return console.error("Required form elements not found"),r.hide(),void this.showAlert("Error initializing borrow form","error");o.value=e,a.value="",n.innerHTML=`\n                        <strong>Package:</strong> ${t.Packagecode}<br>\n                        <strong>Description:</strong> ${t.Packagedescription}<br>\n                        <strong>Total Samples:</strong> ${t.TotalSample}\n                    `}catch(e){console.error("Error loading form data:",e),r.hide(),this.showAlert("Error loading form data","error")}},100)}catch(e){console.error("Error in showBorrowModal:",e),this.showAlert("Error opening borrow modal","error")}borrowPackageIdElement.value=e,verifierSelectElement.value="",borrowPackageDetailsElement.innerHTML=`\n            <strong>Package:</strong> ${pkg.Packagecode}<br>\n            <strong>Description:</strong> ${pkg.Packagedescription}<br>\n            <strong>Total Samples:</strong> ${pkg.TotalSample}\n        `}async submitBorrow(){console.log("submitBorrow called");const e=document.getElementById("borrowPackageId").value,t=document.getElementById("verifierSelect").value;if(console.log("Borrow form data:",{packageId:e,verifierId:t}),!t)return console.log("No verifier selected"),void this.showAlert("Please select a verifier","danger");if(await this.apiCall("/borrow","POST",{packageId:e,verifierId:t})){console.log("Borrow successful"),this.showAlert("Package borrowed successfully!","success");try{const e=document.getElementById("borrowModal"),t=bootstrap.Modal.getInstance(e);t&&(console.log("Hiding borrow modal"),t.hide())}catch(e){console.error("Error hiding borrow modal:",e)}const e=document.getElementById("borrowPackageId"),t=document.getElementById("verifierSelect"),o=document.getElementById("borrowPackageDetails");e&&(e.value=""),t&&(t.value=""),o&&(o.innerHTML=""),setTimeout(()=>{this.loadPackages(),this.loadBorrowHistory()},100)}else console.log("Borrow failed")}async returnItem(e){if(!confirm("Are you sure you want to return this item?"))return;await this.apiCall(`/return/${e}`,"POST")&&(this.showAlert("Return initiated successfully!","success"),this.loadBorrowHistory())}async showVerifyReturnModal(e){try{const t=parseInt(e);this.borrowHistory&&0!==this.borrowHistory.length||await this.loadBorrowHistory();const o=this.borrowHistory.find(o=>o.ID===t||o.ID===e||parseInt(o.ID)===t);if(!o)return console.error("Borrow item not found:",e,"Available items:",this.borrowHistory),void this.showAlert("Item not found","error");document.getElementById("returnedSamples").value="",document.getElementById("justification").value="",document.getElementById("verifyBorrowId").value=e,document.getElementById("expectedSamples").innerHTML=`Expected: ${o.expected_samples||0} samples`;const r=document.getElementById("verifyReturnModal");if(!r)return console.error("Verify return modal element not found"),void this.showAlert("Error opening verification modal","error");try{let e=bootstrap.Modal.getInstance(r);e||(e=new bootstrap.Modal(r,{backdrop:"static",keyboard:!1})),setTimeout(()=>{e.show()},10)}catch(e){console.error("Error showing verify return modal:",e),this.showAlert("Error opening verification modal","error")}}catch(e){console.error("Error showing verify modal:",e),this.showAlert("Error opening verification modal","error")}}async submitVerifyReturn(){try{const e=document.getElementById("verifyBorrowId").value,t=document.getElementById("returnedSamples").value,o=document.getElementById("justification").value;if(!e)return void this.showAlert("Invalid verification request","error");if(!t||""===t)return void this.showAlert("Please enter the number of returned samples","warning");if(parseInt(t)<0)return void this.showAlert("Returned samples cannot be negative","warning");const r=document.getElementById("expectedSamples").textContent,a=parseInt(r.match(/\d+/)[0]),n=parseInt(t);if(n!==a&&(!o||""===o.trim()))return this.showAlert("Justification is required when returned samples differ from expected samples","warning"),void document.getElementById("justification").focus();const s=document.getElementById("submitVerifyReturnBtn"),i=s.innerHTML;s.innerHTML='<i class="fas fa-spinner fa-spin me-2"></i>Verifying...',s.disabled=!0;const l=await this.apiCall(`/verify-return/${e}`,"POST",{returnedSamples:n,justification:o||""});if(s.innerHTML=i,s.disabled=!1,l){this.showAlert("Return verified successfully!","success");try{const e=document.getElementById("verifyReturnModal"),t=bootstrap.Modal.getInstance(e);t&&t.hide()}catch(e){console.error("Error hiding verify return modal:",e)}document.getElementById("returnedSamples").value="",document.getElementById("justification").value="",document.getElementById("verifyBorrowId").value="",setTimeout(()=>{this.loadBorrowHistory(),this.loadPackages()},100)}}catch(e){console.error("Error verifying return:",e),this.showAlert("Error verifying return","error");const t=document.getElementById("submitVerifyReturnBtn");t&&(t.innerHTML='<i class="fas fa-check me-2"></i>Verify Return',t.disabled=!1)}}applyFilters(){this.allPackages||(this.allPackages=[...this.packages]);const e=document.getElementById("filterPackageCode")?.value.toLowerCase()||"",t=document.getElementById("filterCategory")?.value||"",o=document.getElementById("filterShift")?.value||"",r=document.getElementById("filterAvailable")?.value||"",a=this.allPackages.filter(a=>{const n=!e||(a.Packagecode||"").toLowerCase().includes(e),s=!t||a.Category===t,i=!o||a["SampleCreatedByShift(A/B/C)"]===o,l=!r||a["MATERIAL AT ENG ROOM"]===r;return n&&s&&i&&l});this.packages=a,this.renderPackagesTable()}toggleFilters(){const e=document.getElementById("filtersContainer");e.style.display="none"===e.style.display?"block":"none"}refreshPackages(){["filterPackageCode","filterCategory","filterShift","filterAvailable"].forEach(e=>{const t=document.getElementById(e);t&&(t.value="")}),this.loadPackages()}async editPackage(e){try{const t=parseInt(e),o=(this.allPackages||this.packages).find(o=>o.ID==e||o.ID==t);if(!o)return void this.showAlert("Package not found","error");await this.loadEditFormOptions(),this.generateEditDefectCountInputs(),document.getElementById("editPackageId").value=o.ID,document.getElementById("editPackageCode").value=o.Packagecode||o.PackageCode||"",document.getElementById("editTemporaryCabinet").value=o["Temporary Cabinet"]||o.TemporaryCabinet||"",document.getElementById("editPackageDescription").value=o.Packagedescription||o.PackageDescription||"",setTimeout(()=>{document.getElementById("editCategory").value=o.Category||""},100),document.getElementById("editSampleCreatedByShift").value=o["SampleCreatedByShift(A/B/C)"]||o.SampleCreatedByShift||"";const r=document.getElementById("editDefectCountsContainer");r.querySelectorAll('input[type="number"]').forEach(e=>{const t=e.name,r=o[t];e.value=null!=r?r:0}),this.calculateEditTotalSamples();const a=document.getElementById("editModal");if(!a)return console.error("Edit modal element not found"),void this.showAlert("Error opening edit modal","error");try{let e=bootstrap.Modal.getInstance(a);e||(e=new bootstrap.Modal(a,{backdrop:"static",keyboard:!1})),setTimeout(()=>{e.show()},10)}catch(e){console.error("Error showing edit modal:",e),this.showAlert("Error opening edit modal","error")}}catch(e){console.error("Error loading package for edit:",e),this.showAlert("Error loading package details","error")}}async loadEditFormOptions(){try{const e=await fetch(`${this.API_BASE}/packages/options`,{headers:{Authorization:`Bearer ${this.token}`}}),t=await e.json(),o=document.getElementById("editCategory");o.innerHTML='<option value="">Select Category</option>',t.categories.forEach(e=>{o.innerHTML+=`<option value="${e}">${e}</option>`})}catch(e){console.error("Error loading edit form options:",e)}}generateEditDefectCountInputs(){const e=document.getElementById("editDefectCountsContainer");e.innerHTML="";["Dummyunit","WhiteFM(Substrate)","BlackFM(Substrate)","Chip(Substrate)","Scratches(Substrate)","Crack(Substrate)","FMonFoot(Substrate)","FMonShoulder(Substrate)","NFA(Substrate)","PFA(Substrate)","Footburr(Substrate)","Shoulderbur(Substrate)","Exposecopper(Substrate)","Resinbleed(Substrate)","void(Substrate)","Copla(Substrate)","WhiteFM(Mold/MetalLid)","BlackFM(Mold/MetalLid)","EdgeChip(Mold/MetalLid)","CornerChip(Mold/MetalLid)","Scratches(Mold/MetalLid)","Crack(Mold/MetalLid)","Illegiblemarking(Mold/MetalLid)","WhiteFM(Die)","BlackFM(Die)","Chip(Die)","Scratches(Die)","Crack(Die)","WhiteFM(BottomDefect)","BlackFM(BottomDefect)","Chip(BottomDefect)","Scratches(BottomDefect)","Crack(BottomDefect)","Damageball(BottomDefect)","Multiple Defect","Pitch","Sliver","Ball Discoloration","Burr","FM on Dambar","FM on Lead","Expose Copper on Dambar","Mold Flash","Metallic Particle","Patchback","Bent Lead","Expose Tie Bar","Fiber","Tool Mark","Good Unit","Lead Shining","Acid Test Burr"].forEach(t=>{const o=document.createElement("div");o.className="col-md-3 col-sm-6";const r=t.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase());o.innerHTML=`\n                <div class="mb-2">\n                    <label class="form-label small">${r}</label>\n                    <input type="number" class="form-control form-control-sm edit-defect-input"\n                           id="edit${t}" name="${t}" min="0" value="0">\n                </div>\n            `,e.appendChild(o)})}calculateEditTotalSamples(){const e=document.getElementById("editDefectCountsContainer").querySelectorAll('input[type="number"]');let t=0;e.forEach(e=>{t+=parseInt(e.value)||0}),document.getElementById("editTotalSamples").value=t}async submitEditPackage(){try{const e=document.getElementById("editPackageId").value,t=document.getElementById("editPackageCode").value.trim(),o=document.getElementById("editTemporaryCabinet").value.trim(),r=document.getElementById("editPackageDescription").value.trim(),a=document.getElementById("editCategory").value,n=document.getElementById("editSampleCreatedByShift").value;if(!(t&&o&&a&&n))return void this.showAlert("Please fill in all required fields","error");const s={},i=document.getElementById("editDefectCountsContainer");i.querySelectorAll('input[type="number"]').forEach(e=>{const t=e.name;s[t]=parseInt(e.value)||0});const l={Packagecode:t,"Temporary Cabinet":o,Packagedescription:r,Category:a,"SampleCreatedByShift(A/B/C)":n,...s},c=await fetch(`${this.API_BASE}/packages/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.token}`},body:JSON.stringify(l)});if(c.ok){this.showAlert("Package updated successfully!","success");try{const e=bootstrap.Modal.getInstance(document.getElementById("editModal"));e&&e.hide()}catch(e){console.error("Error hiding edit modal:",e)}this.loadPackages()}else{const e=await c.json();this.showAlert(e.message||"Error updating package","error")}}catch(e){console.error("Error updating package:",e),this.showAlert("Error updating package","error")}}viewPackageDetails(e){try{const t=(this.allPackages||this.packages).find(t=>t.ID==e||t.ID==parseInt(e));if(!t)return void this.showAlert("Package not found","error");document.getElementById("viewPackageId").textContent=t.ID,document.getElementById("viewPackageCode").textContent=t.Packagecode||"",document.getElementById("viewPackageDescription").textContent=t.Packagedescription||"",document.getElementById("viewTemporaryCabinet").textContent=t["Temporary Cabinet"]||"",document.getElementById("viewCategory").textContent=t.Category||"",document.getElementById("viewShift").textContent=t["SampleCreatedByShift(A/B/C)"]||"";const o=document.getElementById("viewAvailability");"YES"===t["MATERIAL AT ENG ROOM"]?o.innerHTML='<span class="badge bg-success">Available</span>':o.innerHTML='<span class="badge bg-danger">Not Available</span>',document.getElementById("viewTotalSamples").textContent=t.TotalSample||0,this.populateViewDefectCounts(t);const r=document.getElementById("viewDetailsModal");if(!r)return console.error("View details modal element not found"),void this.showAlert("Error opening view details modal","error");try{let e=bootstrap.Modal.getInstance(r);e||(e=new bootstrap.Modal(r,{backdrop:"static",keyboard:!0})),setTimeout(()=>{e.show()},10)}catch(e){console.error("Error showing view details modal:",e),this.showAlert("Error opening view details modal","error")}}catch(e){console.error("Error loading package details:",e),this.showAlert("Error loading package details","error")}}populateViewDefectCounts(e){const t=document.getElementById("viewDefectCountsContainer");t.innerHTML="";["Dummyunit","WhiteFM(Substrate)","BlackFM(Substrate)","Chip(Substrate)","Scratches(Substrate)","Crack(Substrate)","FMonFoot(Substrate)","FMonShoulder(Substrate)","NFA(Substrate)","PFA(Substrate)","Footburr(Substrate)","Shoulderbur(Substrate)","Exposecopper(Substrate)","Resinbleed(Substrate)","void(Substrate)","Copla(Substrate)","WhiteFM(Mold/MetalLid)","BlackFM(Mold/MetalLid)","EdgeChip(Mold/MetalLid)","CornerChip(Mold/MetalLid)","Scratches(Mold/MetalLid)","Crack(Mold/MetalLid)","Illegiblemarking(Mold/MetalLid)","WhiteFM(Die)","BlackFM(Die)","Chip(Die)","Scratches(Die)","Crack(Die)","WhiteFM(BottomDefect)","BlackFM(BottomDefect)","Chip(BottomDefect)","Scratches(BottomDefect)","Crack(BottomDefect)","Damageball(BottomDefect)","Multiple Defect","Pitch","Sliver","Ball Discoloration","Burr","FM on Dambar","FM on Lead","Expose Copper on Dambar","Mold Flash","Metallic Particle","Patchback","Bent Lead","Expose Tie Bar","Fiber","Tool Mark","Good Unit","Lead Shining","Acid Test Burr"].forEach(o=>{const r=e[o]||0,a=o.replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase()),n=document.createElement("div");n.className="col-md-6 col-sm-12";const s=r>0?"bg-warning text-dark":"bg-light text-muted";n.innerHTML=`\n                <div class="d-flex justify-content-between align-items-center mb-1 p-1 border-bottom">\n                    <small class="text-muted">${a}</small>\n                    <span class="badge ${s}">${r}</span>\n                </div>\n            `,t.appendChild(n)})}showAlert(e,t="info"){const o=`\n            <div class="alert alert-${t} alert-dismissible fade show position-fixed"\n                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">\n                ${e}\n                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",o),setTimeout(()=>{const e=document.querySelector(".alert:last-of-type");if(e){new bootstrap.Alert(e).close()}},5e3)}}if(window.addEventListener("error",function(e){console.error("Global error caught:",e.error),console.error("Error message:",e.message),console.error("Error filename:",e.filename),console.error("Error lineno:",e.lineno),console.error("Error colno:",e.colno)}),document.addEventListener("DOMContentLoaded",function(){console.log("DOM Content Loaded - initializing StorageManager"),console.log("Bootstrap available:","undefined"!=typeof bootstrap),"undefined"==typeof bootstrap&&console.error("Bootstrap is not loaded! Modal functionality will not work.");const e=new StorageManager;window.logout=function(){console.log("Global logout function called"),e.logout()},window.toggleFilters=function(){console.log("Global toggleFilters function called"),e.toggleFilters()},window.refreshPackages=function(){console.log("Global refreshPackages function called"),e.refreshPackages()},window.submitBorrow=function(){console.log("Global submitBorrow function called"),e.submitBorrow()},window.submitVerifyReturn=function(){console.log("Global submitVerifyReturn function called"),e.submitVerifyReturn()},window.storageManager=e}),"loading"===document.readyState)document.addEventListener("DOMContentLoaded",function(){});else{console.log("DOM already loaded - initializing StorageManager immediately"),console.log("Bootstrap available (immediate):","undefined"!=typeof bootstrap),"undefined"==typeof bootstrap&&console.error("Bootstrap is not loaded (immediate)! Modal functionality will not work.");const e=new StorageManager;window.logout=function(){console.log("Global logout function called (immediate)"),e.logout()},window.toggleFilters=function(){console.log("Global toggleFilters function called (immediate)"),e.toggleFilters()},window.refreshPackages=function(){console.log("Global refreshPackages function called (immediate)"),e.refreshPackages()},window.submitBorrow=function(){console.log("Global submitBorrow function called (immediate)"),e.submitBorrow()},window.submitVerifyReturn=function(){console.log("Global submitVerifyReturn function called (immediate)"),e.submitVerifyReturn()},window.storageManager=e}